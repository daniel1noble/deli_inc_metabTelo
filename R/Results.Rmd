---
title: "Results"
author: "Fonti Kar"
date: "`r Sys.Date()`"
output:
  word_document:
    reference_docx: Style_guide.docx
  html_document:
    df_print: paged
---

```{r setup, eval = TRUE, include = FALSE, echo = FALSE}
knitr::opts_chunk$set(eval = FALSE,
                      echo = FALSE, 
                      include = FALSE, 
                      warning = FALSE,
                      message = FALSE)
rm(list=ls())
sessionInfo()

# R version 3.6.1 (2019-07-05)
# Platform: x86_64-apple-darwin15.6.0 (64-bit)
# Running under: macOS High Sierra 10.13.6

pacman::p_load(dplyr, magrittr, ggplot2, purrr, Rphylopars, phytools, GGally, mice, janitor, patchwork, GGally, psych, brms, mi, pander,latex2exp, stringr)

my_theme <- theme(#legend.position = "none",
  legend.position = "bottom",
  legend.text =element_text(size = 14),
  legend.title =element_text(size = 14, face = "bold"),
  panel.grid.major = element_blank(), 
  panel.grid.minor = element_blank(),
  axis.text=element_text(size=16),
  axis.title=element_text(size=16),
  plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
  plot.background = element_rect(colour = "white"))

source("~/Dropbox/1 - PhD/5 - Ldeli_inc_metabTelo/R/functions/helper.R")
```

$$I_{t} = V_{I} + (t^2.V_{S}) + (2t.Cov_{I,S}) $$

where $V_I$ is the among individual variance in intercepts, $t$ is the specific temperature at which repeatability is calculated for, $V_S$ is the among individual and $COV_{I,S}$ is the covariance between the intercept and slope at the among individual level. Temperature specific repeatability ($R_{t}$) is calculated as follows: 

$$R_{t} = \displaystyle \frac{I_{t}}{(I_{t} + V_{session} + V_{e})} $$

where: $I_{t}$ is the variance among individuals at a particular temperature, $V_{session}$ is the variance due to sampling session and $V_{e}$ is residual variance. 

$$R_{slope} = \displaystyle \frac{V_{I,slope}}{(V_{I,slope} + V_{series, slope})} $$
where: $V_{I,slope}$ is the among individual variance in the temperature slope term and the $V_{series, slope}$ is the among sampling session within individual variance in the temperature slope term

```{r, eval = TRUE}
## Read in data
data <-read.csv("~/Dropbox/1 - PhD/5 - Ldeli_inc_metabTelo/data/processed/Long_Tinc_MR.csv", stringsAsFactors = F)
mi_data <-read.csv("~/Dropbox/1 - PhD/5 - Ldeli_inc_metabTelo/data/processed/Long_Tinc_MR_MI.csv", stringsAsFactors = F)
```

```{r, eval = TRUE}
#Tabulate the model coefficients for imp model
#Read in model
mod.imp.3.obj <- readRDS("~/Dropbox/1 - PhD/5 - Ldeli_inc_metabTelo/output/rds/mod.imp.3")

#Extract entire posterior
mod.imp.3_post <- posterior_samples(mod.imp.3.obj)
#Names of each column
colnames(mod.imp.3_post)[1:14]

#Combining the coefficients from the final model
#Getting the fixed effects
mod.imp.3_fixed <- mod.imp.3_post[1:7] %>% posterior_summary() %>% round(3) 

#Getting the SD 
mod.imp.3_sd <- posterior_samples(mod.imp.3.obj, "sd_")
mod.imp.3_var <- mod.imp.3_sd^2 
names(mod.imp.3_var) <- str_replace(names(mod.imp.3_var), "sd", "var")
mod.imp.3_var %>% posterior_summary() %>% round(3) 

#Getting the COR to cov
mod.imp.3_cov <- posterior_samples(mod.imp.3.obj, "cor_") * (mod.imp.3_sd[,1] * mod.imp.3_sd[,2])
names(mod.imp.3_cov) <- str_replace(names(mod.imp.3_cov), "cor", "cov")

mod.imp.3_cov %>% posterior_summary() %>% signif(3) 

#Getting the residuals
mod.imp.3_residuals <- ( posterior_samples(mod.imp.3.obj, "sigma")^2 ) %>% posterior_summary() %>% round(3) 

#Bind these together
mod.imp.3_coeffs <- rbind(mod.imp.3_fixed,
                              mod.imp.3_var %>% posterior_summary() %>% round(3),
                              mod.imp.3_cov %>% posterior_summary() %>% signif(3),
                              mod.imp.3_residuals)
        
#Excluding est. error
mod.imp.3_coeffs <- mod.imp.3_coeffs[,c(1,3,4)]
#Rownames as col
mod.imp.3_coeffs <- as.data.frame(mod.imp.3_coeffs)
mod.imp.3_coeffs$Parameter <- c(rownames(mod.imp.3_coeffs))
rownames(mod.imp.3_coeffs) <- NULL 
mod.imp.3_coeffs <- mod.imp.3_coeffs[,c(4,1:3)]
```

```{r, eval = TRUE, include = TRUE}
pander(mod.imp.3_coeffs,
       justify = "lccc",
       #split.cell = 80,
       caption = "Table 1 Model coefficients of full model testing whether developmental temperature affects the elevation and slope of the thermal reaction norm of metabolic rate. This model used an imputated dataset, n = 6000")
```

```{r, eval = TRUE, cache = TRUE}
#Read in model
mod.imp.3.obj <- readRDS("~/Dropbox/1 - PhD/5 - Ldeli_inc_metabTelo/output/rds/mod.imp.3")

#Make a figure from model predictions using mod.imp.3.obj
mod.3.imp.post <- posterior_samples(mod.imp.3.obj) 
names(mod.3.imp.post)[1:14]
names(mod.3.imp.post)[120:150]

#Specificying the posterior
post = mod.3.imp.post

#Setting up predictive data
new_data <- mi_data %>% distinct(id, samp_session, temp, treatment)

#Try pmap
imp_model_predictions <- bind_rows(pmap(new_data, imp_mr_pred))
str(imp_model_predictions)
rownames(imp_model_predictions) <- NULL

#Check it
imp_model_predictions %>% filter(id == "ld0449" & samp_session == 1) #Fantastic

#Change ID to character
imp_model_predictions %<>%  mutate(id = as.character(id))

#Plot it
cold_ids <- imp_model_predictions %>% filter(treatment == 23) %>% pull(id) %>% unique()
hot_ids <- imp_model_predictions %>% filter(treatment == 29) %>% pull(id) %>% unique()

set.seed(7)
subset_cold <- sample(cold_ids, 10 , replace = F)

set.seed(7)
subset_hot <- sample(hot_ids, 10 , replace = F)
```

```{r, eval = TRUE, include = TRUE, fig.height = 6.7, fig.width = 9.5}
#Filter out the subset IDS
imp_model_predictions %>% filter(id %in% c(subset_cold, subset_hot) & samp_session %in% c(1,5,10)) %>% 
  ggplot(aes(x = temp, y = mean_lnmr)) + 
  geom_line(aes(group = id, colour = factor(treatment)), stat="smooth", method = "lm", lwd = 0.5, alpha = 0.5) + 
  geom_line(aes(group = factor(treatment), colour = factor(treatment)), stat="smooth", method = "lm", lwd = 2, alpha = 1, position=position_dodge(width = 0.3)) +
  #geom_point(alpha = 0.2) + 
  facet_wrap(~samp_session) + 
  scale_colour_manual(values = c("#2790F3", "#F24D2A")) + 
  scale_x_continuous(breaks = c(seq(24,34, by = 2))) + 
  scale_y_continuous(breaks = c(seq(-6.5,-5.2, by = 0.25))) + 
  labs(x = "Temperature",
       y = TeX("log VCO_2 min^{-1}"),
       #title = "Relative contribution of variance over age",
       colour =  "Treatment") + 
  theme_bw() +
  my_theme + 
  theme(legend.position = "none",
        strip.text = element_text(size = 18),
        strip.background = element_blank())

#Raw data
brewer.pal(10, "PuOr")
brewer.pal(10, "PRGn")
brewer.pal(10, "RdGy")

hot_col <- c("red3", "tomato2", "sienna1", "orangered", "chocolate1", 
             "indianred2", "sandybrown", "firebrick1", "darkred", "saddlebrown")

cold_col <- c("royalblue4", "cornflowerblue", "lightseagreen", "lightskyblue", "lightsteelblue3", 
             "cadetblue", "skyblue3", "skyblue4", "turquoise4", "steelblue1")

#HOT
raw_hot <- data %>% filter(treatment == 29 & samp_session %in% c(1,5,10)) %>% filter(id %in% c(subset_hot)) %>% 
  ggplot(aes(x = temp, y = lnmr)) + 
  geom_line(aes(group = id, colour = factor(id)), stat="smooth", method = "lm", lwd = 0.5, alpha =1) + 
  #geom_line(color = "#F24D2A", stat="smooth", method = "lm", lwd = 2, alpha = 0.7) +
  facet_wrap(~samp_session) + 
  scale_colour_manual(values = hot_col) + 
  scale_x_continuous(breaks = c(seq(24,34, by = 2))) + 
  scale_y_continuous(lim = c(-7.2,-5.3)) + 
  labs(x = " ",
       y = TeX("log VCO_2 min^{-1}"),
       #title = "Relative contribution of variance over age",
       colour =  "Treatment") + 
  theme_bw() +
  my_theme + 
  theme(legend.position = "none",
        strip.text = element_text(size = 18),
        strip.background = element_blank())

#COLD
raw_cold <- data %>% filter(id %in% subset_cold & samp_session %in% c(1,5,10)) %>% 
  ggplot(aes(x = temp, y = lnmr)) + 
  geom_line(aes(group = id, colour = factor(id)), stat="smooth", method = "lm", lwd = 0.5, alpha = 1) + 
  #geom_line(color = "#2790F3", stat="smooth", method = "lm", lwd = 2, alpha = 0.8) +
  facet_wrap(~samp_session) + 
  scale_colour_manual(values = cold_col) + 
  scale_x_continuous(breaks = c(seq(24,34, by = 2))) + 
  scale_y_continuous(lim = c(-7.2,-5.3)) + 
  labs(x = "Temperature",
       y = TeX("log VCO_2 min^{-1}"),
       #title = "Relative contribution of variance over age",
       colour =  "Treatment") + 
  theme_bw() +
  my_theme + 
  theme(legend.position = "none",
        strip.text = element_text(size = 18),
        strip.background = element_blank())
```

```{r}
imp_a <- ggplot(rpt_data, aes(x = factor(temp), y = rpt, group = treatment, colour = treatment)) + 
  geom_point(position = position_dodge(0.5), size = 4) + 
  geom_errorbar(aes(ymin = Lower, ymax = Upper), width = 0, position = position_dodge(0.5), size = 0.6) + 
  scale_colour_manual(values = c("#2790F3", "#F24D2A")) +
  ylim(c(0, 0.4)) + 
  labs(x = "Temperature",
       y = "Repeatability",
       colour =  "Treatment") + 
  theme_bw() +
  my_theme + 
  theme(legend.position = "none") 

imp_b <- ggplot(rpt_data_mode, aes(x = factor(temp), y = rpt, group = treatment, colour = treatment)) + 
  geom_point(position = position_dodge(0.5), size = 4) + 
  geom_errorbar(aes(ymin = Lower, ymax = Upper), width = 0, position = position_dodge(0.5), size = 0.6) + 
  scale_colour_manual(values = c("#2790F3", "#F24D2A")) +
  ylim(c(0, 0.4)) + 
  labs(x = "Temperature",
       y = "Repeatability",
       colour =  "Treatment") + 
  theme_bw() +
  my_theme + 
  theme(legend.position = "none") 

plot_layout(imp_a / imp_b)
plot_layout(raw_hot / raw_cold)
```


```{r, eval = TRUE}
#Treatment differences in temperature specific repeatabilty using imputation models
# Read in models
cold_imp.obj <- readRDS("~/Dropbox/1 - PhD/5 - Ldeli_inc_metabTelo/output/rds/cold.mod.imp.3")
hot_imp.obj <- readRDS("~/Dropbox/1 - PhD/5 - Ldeli_inc_metabTelo/output/rds/hot.mod.imp.3")

#Poster names
names(posterior_samples(cold_imp.obj))[1:10]

#Temp define:
temp <- seq(24,34, by = 2)
# map(temp, 
#     brms_rpt_imp) #Can't get this to work

imp_cold_rpt <- bind_rows(lapply(temp, function(x) brms_rpt_imp(x, model = cold_imp.obj)))
imp_cold_rpt %<>%  mutate(treatment = "cold")

imp_hot_rpt <- bind_rows(lapply(temp, function(x) brms_rpt_imp(x, model = hot_imp.obj)))
imp_hot_rpt %<>%  mutate(treatment = "hot")

imp_rpt_data <- bind_rows(imp_cold_rpt, imp_hot_rpt)

#Posterior mode
imp_cold_mode <- bind_rows(lapply(temp, function(x) brms_rpt_imp(x, model = cold_imp.obj, type = "mode")))
imp_cold_mode %<>%  mutate(treatment = "cold")

imp_hot_mode <- bind_rows(lapply(temp, function(x) brms_rpt_imp(x, model = hot_imp.obj, type = "mode")))
imp_hot_mode %<>%  mutate(treatment = "hot")

imp_rpt_mode <- bind_rows(imp_cold_mode, imp_hot_mode)
```

```{r, eval = TRUE, include = TRUE, fig.height = 6.7, fig.width = 9.5, cache = TRUE}
#Fig 2
ggplot(imp_rpt_data, aes(x = factor(temp), y = rpt, group = treatment, colour = treatment)) + 
  geom_point(position = position_dodge(0.5), size = 4) + 
  geom_errorbar(aes(ymin = Lower, ymax = Upper), width = 0, position = position_dodge(0.5), size = 0.6) + 
  scale_colour_manual(values = c("#2790F3", "#F24D2A")) +
  ylim(c(0, 0.40)) + 
  labs(x = "Temperature",
       y = "Repeatability",
       colour =  "Treatment") + 
  theme_bw() +
  my_theme + 
  theme(legend.position = "none") 
```

```{r}
imp_a <- ggplot(imp_rpt_data, aes(x = factor(temp), y = rpt, group = treatment, colour = treatment)) + 
  geom_point(position = position_dodge(0.5), size = 4) + 
  geom_errorbar(aes(ymin = Lower, ymax = Upper), width = 0, position = position_dodge(0.5), size = 0.6) + 
  scale_colour_manual(values = c("#2790F3", "#F24D2A")) +
  ylim(c(0, 0.26)) + 
  labs(x = "Temperature",
       y = "Repeatability",
       colour =  "Treatment") + 
  theme_bw() +
  my_theme + 
  theme(legend.position = "none") 

imp_b <- ggplot(imp_rpt_mode, aes(x = factor(temp), y = rpt, group = treatment, colour = treatment)) + 
  geom_point(position = position_dodge(0.5), size = 4) + 
  geom_errorbar(aes(ymin = Lower, ymax = Upper), width = 0, position = position_dodge(0.5), size = 0.6) + 
  scale_colour_manual(values = c("#2790F3", "#F24D2A")) +
  ylim(c(0, 0.26)) + 
  labs(x = "Temperature",
       y = "Repeatability",
       colour =  "Treatment") + 
  theme_bw() +
  my_theme + 
  theme(legend.position = "none") 

plot_layout(imp_a / imp_b)
```

```{r}
#Investigating the among and residual variance
temp <- seq(24,34, by = 2)

var_comp_cold <- bind_rows(lapply(temp, function(x) var_comp_imp(x, model = cold_imp.obj, var_comp = "id")),
                           lapply(temp, function(x) var_comp_imp(x, model = cold_imp.obj, var_comp = "sigma")))
var_comp_cold %<>%  mutate(treatment = "cold")

var_comp_hot <- bind_rows(lapply(temp, function(x) var_comp_imp(x, model = hot_imp.obj, var_comp = "id")),
                           lapply(temp, function(x) var_comp_imp(x, model = hot_imp.obj, var_comp = "sigma")))
var_comp_hot %<>%  mutate(treatment = "hot")

var_comps <- bind_rows(var_comp_cold, var_comp_hot)

ggplot(data = var_comps, aes(x = factor(temp), y = variance)) + 
  geom_col(aes(fill = var_comp), stat = "identity", position = "dodge") + 
  geom_errorbar(aes(ymin = Lower, ymax = Upper, width = 0), position = "dodge") + 
  theme_bw() + 
  facet_wrap(~treatment)

ggplot(data = var_comps, aes(x = var_comp, y = variance)) + 
  geom_col(aes(fill = var_comp),position = "dodge") + 
  geom_errorbar(aes(ymin = Lower, ymax = Upper, width = 0)) + 
  theme_bw() + 
  facet_wrap(~treatment)


ggplot(data = var_comps, aes(x = var_comp, y = variance)) + 
  geom_col(aes(fill = var_comp), stat = "identity",position = "dodge") + 
  theme_bw() + 
  facet_wrap(~treatment)


ggplot(data = var_comps, aes(x = factor(temp), y = variance)) + 
  geom_point(aes(colour = var_comp),  position = "dodge") + 
  geom_errorbar(aes(ymin = Lower, ymax = Upper, width = 0), position = "dodge") + 
  theme_bw() + 
  facet_wrap(~treatment)


```


```{r, eval = TRUE, include= TRUE}
#Tabulating repeatability at each temperature
imp_rpt_data %<>% select(treatment, temp:Upper)

pander(imp_rpt_data,
       justify = "lcccc",
       #split.cell = 80,
       caption = "Table 2 Temeprature specific, adjusted repeatability estimates of log transformed metabolic rate for lizards from two developmental temperatures (n_hot = 25, n_cold = 26). These values were estimated from an imputation analysis, n_obs = 6000")
```

```{r}
#Are there actually any significant differences in T specific repeatability of average MR? Answer is no
diff_24 <- rpt_posterior(x = 24, model = hot_imp.obj) - rpt_posterior(x = 24, model = cold_imp.obj)
posterior_summary(diff_24) %>% round(3)

diff_26 <- rpt_posterior(x = 26, model = hot_imp.obj) - rpt_posterior(x = 26, model = cold_imp.obj)
posterior_summary(diff_26) %>% round(3)

diff_28 <- rpt_posterior(x = 28, model = hot_imp.obj) - rpt_posterior(x = 28, model = cold_imp.obj)
posterior_summary(diff_28) %>% round(3)

diff_30 <- rpt_posterior(x = 30, model = hot_imp.obj) - rpt_posterior(x = 30, model = cold_imp.obj)
posterior_summary(diff_30) %>% round(3)

diff_32 <- rpt_posterior(x = 32, model = hot_imp.obj) - rpt_posterior(x = 32, model = cold_imp.obj)
posterior_summary(diff_32) %>% round(3)

diff_34 <- rpt_posterior(x = 34, model = hot_imp.obj) - rpt_posterior(x = 34, model = cold_imp.obj)
posterior_summary(diff_34) %>% round(3)
```

```{r}
#Repeatability of the slope for each treatment
#Imputed
cold.mod.imp.4 <- readRDS("output/rds/cold.mod.imp.4")
hot.mod.imp.4 <- readRDS("output/rds/hot.mod.imp.4")

brms_rptSlope_imp(model = cold.mod.imp.4)
brms_rptSlope_imp(model = hot.mod.imp.4)
```

## How does developmental temperature affect temperature specific repeatability

Across both treatment grounts, repeatability did not change across acute temperatures (Fig.2, Table XX). There were no differences in repeatability between developmental temperatures (Fig. 2, Table XX). Although in the complete case analysis there was a trend for the cold developmental temperatures to have on higher repeatabilty compared to the hot developmental temeprature however credible intervals overlapped partially (Fig. XX, Table XX) and this result was not reflected in the more conservative imputation analysis. The slope of the thermal reaction norm was repeatable in both treatment groups, however there were no treatment differences (Fig. XX and). This result should be interpretted with caution as repeatability of the slope was estimated with a large degree of uncertainty (95% CI) 
